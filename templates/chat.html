<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4facfe">
    <title>Flask Чат - {{ username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('manifest') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Flask Чат</h1>
            <div class="user-info">
                <span>Вы: <strong>{{ username }}</strong></span>
                <div class="header-links">
                    {% if user_role in ['admin', 'moderator'] %}
                    <a href="{{ url_for('admin_panel') }}">Панель модератора</a>
                    {% endif %}
                    <a href="{{ url_for('support') }}">Поддержка</a>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Выйти</a>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div class="users-sidebar">
                <div class="online-section">
                    <h3>Онлайн (<span id="online-count">{{ online_users|length }}</span>)</h3>
                    <ul id="users-list" class="users-list">
                        {% for user in online_users %}
                        <li class="user-item {% if user == username %}current-user{% endif %}">
                            <span class="user-name">{{ user }}{% if user == username %} (Вы){% endif %}</span>
                            <span class="online-dot active"></span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="user-actions">
                    <button onclick="refreshOnlineUsers()" class="btn-secondary">Обновить список</button>
                </div>
            </div>

            <div class="chat-area">
                <div id="messages" class="messages-container">
                    {% for msg in messages %}
                    <div class="message {% if msg.username == username %}own-message{% endif %} {% if msg.type == 'system' %}system-message{% endif %}">
                        <div class="message-header">
                            <span class="username">{{ msg.username }}</span>
                            <span class="timestamp">{{ msg.timestamp }}</span>
                        </div>
                        <div class="message-content">{{ msg.message }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="message-input-area">
                    <input type="text" id="message-input" placeholder="Введите сообщение..." maxlength="500">
                    <button onclick="sendMessage()" id="send-btn">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                refreshMessages();
                refreshOnlineUsers();
            }, 3000);
        }
        
        function stopAutoRefresh() {
            clearInterval(refreshInterval);
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            try {
                const formData = new FormData();
                formData.append('message', message);
                
                const response = await fetch('/send_message', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    messageInput.value = '';
                    refreshMessages();
                } else {
                    alert(result.error || 'Ошибка отправки сообщения');
                }
            } catch (error) {
                alert('Ошибка сети');
            }
        }
        
        async function refreshMessages() {
            try {
                const response = await fetch('/get_messages');
                if (response.ok) {
                    const messages = await response.json();
                    updateMessagesDisplay(messages);
                }
            } catch (error) {
                console.error('Error refreshing messages:', error);
            }
        }
        
        async function refreshOnlineUsers() {
            try {
                const response = await fetch('/get_online_users');
                if (response.ok) {
                    const users = await response.json();
                    updateOnlineUsers(users);
                }
            } catch (error) {
                console.error('Error refreshing users:', error);
            }
        }
        
        function updateMessagesDisplay(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                if (msg.username === '{{ username }}') {
                    messageElement.classList.add('own-message');
                }
                
                if (msg.type === 'system') {
                    messageElement.classList.add('system-message');
                }
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="username">${msg.username}</span>
                        <span class="timestamp">${msg.timestamp}</span>
                    </div>
                    <div class="message-content">${escapeHtml(msg.message)}</div>
                `;
                
                container.appendChild(messageElement);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function updateOnlineUsers(users) {
            const usersList = document.getElementById('users-list');
            const onlineCount = document.getElementById('online-count');
            
            usersList.innerHTML = '';
            onlineCount.textContent = users.length;
            
            users.forEach(user => {
                const userElement = document.createElement('li');
                userElement.className = 'user-item';
                
                if (user === '{{ username }}') {
                    userElement.classList.add('current-user');
                    userElement.innerHTML = `
                        <span class="user-name">${user} (Вы)</span>
                        <span class="online-dot active"></span>
                    `;
                } else {
                    userElement.innerHTML = `
                        <span class="user-name">${user}</span>
                        <span class="online-dot active"></span>
                    `;
                }
                
                usersList.appendChild(userElement);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
            document.getElementById('message-input').focus();
        });
        
        window.addEventListener('beforeunload', stopAutoRefresh);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('{{ url_for("service_worker") }}')
                .then(function(registration) {
                    console.log('ServiceWorker зарегистрирован');
                })
                .catch(function(error) {
                    console.log('Ошибка регистрации ServiceWorker:', error);
                });
        }
    </script>
</body>
</html>

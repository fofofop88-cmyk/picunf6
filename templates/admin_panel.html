<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .user-card.banned {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .user-actions {
            display: flex;
            gap: 10px;
        }
        .ban-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        .ban-form input, .ban-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="chat-header">
            <h1>üî® –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</h1>
            <div class="user-info">
                <span>–í—ã: <strong>{{ username }}</strong> <span class="role-badge role-{{ user_role }}">{{ user_role }}</span></span>
                <div class="header-links">
                    <a href="{{ url_for('chat') }}">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —á–∞—Ç</a>
                    <a href="{{ url_for('logout') }}" class="logout-btn">–í—ã–π—Ç–∏</a>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h2>
            <div id="online-users-list">
                {% for user in online_users %}
                <div class="user-card">
                    <div>
                        <strong>{{ user }}</strong>
                        <span class="role-badge role-{{ get_user_role(user) }}">{{ get_user_role(user) }}</span>
                    </div>
                    <div class="user-actions">
                        <button onclick="warnUser('{{ user }}')" class="btn-warning">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å</button>
                        <button onclick="showBanForm('{{ user }}')" class="btn-danger">üî® –ó–∞–±–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="admin-section">
            <h2>üö´ –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <div id="banned-users-list"></div>
        </div>

        <div class="admin-section">
            <h2>üìä –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <div id="all-users-list"></div>
        </div>

        <!-- –§–æ—Ä–º–∞ –±–∞–Ω–∞ -->
        <div id="ban-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px;">
                <h3>–ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="ban-username"></span></h3>
                <div class="ban-form">
                    <input type="text" id="ban-reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞" style="flex: 1;">
                    <select id="ban-duration">
                        <option value="1">1 —á–∞—Å</option>
                        <option value="24" selected>24 —á–∞—Å–∞</option>
                        <option value="168">7 –¥–Ω–µ–π</option>
                        <option value="720">30 –¥–Ω–µ–π</option>
                        <option value="0">–ù–∞–≤—Å–µ–≥–¥–∞</option>
                    </select>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="banUser()" class="btn-danger">üî® –ó–∞–±–∞–Ω–∏—Ç—å</button>
                    <button onclick="hideBanForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBanUser = '';
        
        function showBanForm(username) {
            currentBanUser = username;
            document.getElementById('ban-username').textContent = username;
            document.getElementById('ban-modal').style.display = 'block';
        }
        
        function hideBanForm() {
            document.getElementById('ban-modal').style.display = 'none';
            currentBanUser = '';
        }
        
        async function banUser() {
            const reason = document.getElementById('ban-reason').value || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª';
            const duration = document.getElementById('ban-duration').value;
            
            const formData = new FormData();
            formData.append('username', currentBanUser);
            formData.append('reason', reason);
            formData.append('duration', duration);
            
            try {
                const response = await fetch('/admin/ban', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    hideBanForm();
                    loadBannedUsers();
                    loadAllUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        async function warnUser(username) {
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:', '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª');
            if (reason === null) return;
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('reason', reason);
            
            try {
                const response = await fetch('/admin/warn', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                alert(result.message);
                loadAllUsers();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        async function unbanUser(username) {
            if (!confirm(`–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) return;
            
            const formData = new FormData();
            formData.append('username', username);
            
            try {
                const response = await fetch('/admin/unban', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadBannedUsers();
                    loadAllUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        async function loadBannedUsers() {
            try {
                const response = await fetch('/admin/banned_users');
                const bannedUsers = await response.json();
                
                const container = document.getElementById('banned-users-list');
                container.innerHTML = '';
                
                bannedUsers.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card banned';
                    userCard.innerHTML = `
                        <div>
                            <strong>${user.username}</strong>
                            <div>–ü—Ä–∏—á–∏–Ω–∞: ${user.reason}</div>
                            <div>–ó–∞–±–∞–Ω–µ–Ω: ${user.banned_at} | –î–æ: ${user.banned_until}</div>
                            <div>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: ${user.banned_by}</div>
                        </div>
                        <button onclick="unbanUser('${user.username}')" class="btn-success">üîì –†–∞–∑–±–∞–Ω–∏—Ç—å</button>
                    `;
                    container.appendChild(userCard);
                });
            } catch (error) {
                console.error('Error loading banned users:', error);
            }
        }
        
        async function loadAllUsers() {
            try {
                const response = await fetch('/admin/users');
                const users = await response.json();
                
                const container = document.getElementById('all-users-list');
                container.innerHTML = '';
                
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = `user-card ${user.is_banned ? 'banned' : ''}`;
                    
                    let status = '';
                    if (user.is_banned) status = 'üö´ –ó–∞–±–∞–Ω–µ–Ω';
                    else if (user.is_online) status = 'üü¢ –û–Ω–ª–∞–π–Ω';
                    else status = '‚ö´ –û—Ñ—Ñ–ª–∞–π–Ω';
                    
                    userCard.innerHTML = `
                        <div>
                            <strong>${user.username}</strong>
                            <span class="role-badge role-${user.role}">${user.role}</span>
                            <div>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${user.warnings}/3 | –°—Ç–∞—Ç—É—Å: ${status}</div>
                        </div>
                        <div class="user-actions">
                            ${!user.is_banned ? `
                                <button onclick="warnUser('${user.username}')" class="btn-warning">‚ö†Ô∏è</button>
                                <button onclick="showBanForm('${user.username}')" class="btn-danger">üî®</button>
                            ` : `
                                <button onclick="unbanUser('${user.username}')" class="btn-success">üîì</button>
                            `}
                        </div>
                    `;
                    container.appendChild(userCard);
                });
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadBannedUsers();
            loadAllUsers();
        });
    </script>
</body>
</html>
